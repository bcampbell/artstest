#!/usr/bin/env python
from __future__ import print_function
import yaml
import re
import sys
from pprint import pprint
import argparse     # >=python 2.7

splitter = re.compile(r'---(.*?)---\s*(.*)$',re.DOTALL)

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument('got', help='file containing scraped data')
    parser.add_argument('expected', help='file containing expected data')
#    parser.add_argument("-v", "--verbose", help="increase output verbosity",
#                    action="store_true")
    args = parser.parse_args()


    try:
        # load and compare two articles
        art_got = Article(args.got)
        art_expected = Article(args.expected)

        errs = art_got.compare(art_expected)
        if len(errs)>0:
            [print("  %s" % (err.encode('utf-8'),), file=sys.stdout) for err in errs]

            return 1
        else:
            return 0
    except BaseException as e:
        print("error: %s" % (e,), file=sys.stderr)
        return 2


class Article:
    def __init__(self, filename): 
        self.filename=filename
        f = open(filename,"r")
        with f:
            data = f.read()
            m = splitter.match(data)
            meta = yaml.load(m.group(1))
            for f in ("headline","published","updated","authors","canonical_url"):
                if f in meta:
                    self.__dict__[f] = meta[f]
                else:
                    self.__dict__[f] = None
            self.content = m.group(2)

    def dump(self):
        print("canonical_url: %s" % (self.canonical_url))
        print("headline: %s" % (self.headline))
        print("published: %s" % (self.published))
        print("updated: %s" % (self.updated))
        print("authors: %s" % (self.authors))
        print("------")
        print(self.content)

    def compare(self,expected):
        errs = []

        # check headline
        if self.headline != expected.headline:
            errs.append("Headline: expected '%s', got '%s'" %(expected.headline,self.headline))

        # check authors
        for author in expected.authors:
            if self.find_author(author) is None:
                errs.append("missing author: '%s'" % (author['name'],))
        for author in self.authors:
            if expected.find_author(author) is None:
                errs.append("extra author: '%s'" % (author['name'],))

        # TODO: everything else :-)

        return errs

    def find_author(self,author):
        for a in self.authors:
            if a['name'] == author['name']:
                return a
        return None

if __name__ == "__main__":
    sys.exit(main())

